
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🚀 AutoGitFlow: GitHub Actions Accelerator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-family: 'Poppins', sans-serif;
      /* Pastel Theme with Brighter Buttons */
      /* Light Theme */
      --bg-light: #FDF6F7; 
      --container-bg-light: #FFFFFF;
      --text-color-light: #4A4A4A; 
      --input-bg-light: #FFFFFF;
      --input-border-light: #E0E0E0; 
      --input-focus-border-light: #A7C7E7; 
      --button-run-bg-light: #4DCC7D; /* Brighter Green */
      --button-run-hover-bg-light: #3DBA6B; 
      --button-cancel-bg-light: #FF6B6B; /* Brighter Red */
      --button-cancel-hover-bg-light: #FF5252;
      --button-text-color: #FFFFFF; /* White text for brighter buttons */
      --theme-toggle-color-light: #7986CB; 
      --heading-color-light: #5C6BC0; 
      --label-color-light: #6D6D6D; 
      --tooltip-bg-light: #616161; 
      --tooltip-text-light: #F5F5F5; 
      --notification-info-bg-light: #E3F2FD; 
      --notification-info-text-light: #1E88E5; 
      --notification-success-bg-light: #E8F5E9; 
      --notification-success-text-light: #43A047; 
      --notification-error-bg-light: #FFEBEE; 
      --notification-error-text-light: #E53935; 
      --notification-warning-bg-light: #FFFDE7; 
      --notification-warning-text-light: #FDD835; 
      --status-card-bg-light: #F1F8E9; 
      --status-card-border-light: #C5E1A5; 
      --footer-text-light: #757575; 

      /* Dark Theme */
      --bg-dark: #2C2C3A; 
      --container-bg-dark: #3A3A4A; 
      --text-color-dark: #E0E0E0; 
      --input-bg-dark: #3A3A4A;
      --input-border-dark: #5C5C6A; 
      --input-focus-border-dark: #8C9EFF; 
      --button-run-bg-dark: #57C75C; /* Brighter Green for Dark */
      --button-run-hover-bg-dark: #4AAE51;
      --button-cancel-bg-dark: #FF7B7B; /* Brighter Red for Dark */
      --button-cancel-hover-bg-dark: #FF6363;
      --button-text-color-dark: #FFFFFF; 
      --theme-toggle-color-dark: #B0BEC5; 
      --heading-color-dark: #A7C7E7; 
      --label-color-dark: #BDBDBD; 
      --tooltip-bg-dark: #E0E0E0; 
      --tooltip-text-dark: #3A3A4A; 
      --notification-info-bg-dark: #2A3B4D;
      --notification-info-text-dark: #82B1FF;
      --notification-success-bg-dark: #2E4B3E;
      --notification-success-text-dark: #A5D6A7;
      --notification-error-bg-dark: #4D2C2C;
      --notification-error-text-dark: #EF9A9A;
      --notification-warning-bg-dark: #4D4A2C;
      --notification-warning-text-dark: #FFF59D;
      --status-card-bg-dark: #3E4B59; 
      --status-card-border-dark: #607D8B; 
      --footer-text-dark: #9E9E9E; 
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-light);
      color: var(--text-color-light);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      transition: background-color 0.4s, color 0.4s;
      position: relative; 
    }
    body::before { /* Subtle noise/grain background */
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        opacity: 0.03; 
        z-index: -1;
        transition: opacity 0.4s;
    }
    body.dark-mode {
      background-color: var(--bg-dark);
      color: var(--text-color-dark);
    }
    body.dark-mode::before {
        opacity: 0.05; 
    }

    .container {
      background-color: var(--container-bg-light);
      padding: 30px 40px; 
      border-radius: 20px; 
      box-shadow: 0 12px 40px rgba(0,0,0,0.08); 
      width: 100%;
      max-width: 700px; 
      text-align: center;
      transition: background-color 0.4s, box-shadow 0.4s;
      z-index: 1; 
      margin-bottom: 20px; /* Adjusted margin for footer */
    }
    body.dark-mode .container {
      background-color: var(--container-bg-dark);
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    }

    h1 {
      margin-top: 0;
      margin-bottom: 35px; 
      font-size: 2.3em; 
      font-weight: 700; 
      color: var(--heading-color-light);
      display: inline-flex; 
      align-items: center;
    }
    h1 .app-icon {
        margin-right: 12px;
        font-size: 1em; 
    }
    body.dark-mode h1 {
      color: var(--heading-color-dark);
    }

    .form-group {
      margin-bottom: 25px; 
      text-align: left;
    }
    .form-group label {
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      font-weight: 500;
      color: var(--label-color-light);
      font-size: 1.05em; 
    }
    body.dark-mode .form-group label {
      color: var(--label-color-dark);
    }
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px; 
      height: 22px;
      border-radius: 50%;
      background-color: var(--label-color-light);
      color: var(--container-bg-light); 
      font-size: 0.8em;
      font-weight: bold;
      margin-left: 10px;
      cursor: help;
      position: relative;
    }
    body.dark-mode .tooltip-icon {
      background-color: var(--label-color-dark);
      color: var(--container-bg-dark);
    }
    .tooltip-icon .tooltip-text {
      visibility: hidden;
      width: 260px; 
      background-color: var(--tooltip-bg-light);
      color: var(--tooltip-text-light);
      text-align: center;
      border-radius: 10px; 
      padding: 12px;
      position: absolute;
      z-index: 10;
      bottom: 135%; 
      left: 50%;
      margin-left: -130px; 
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      font-size: 0.9em;
      font-weight: normal;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transform: translateY(5px);
    }
    body.dark-mode .tooltip-icon .tooltip-text {
      background-color: var(--tooltip-bg-dark);
      color: var(--tooltip-text-dark);
    }
    .tooltip-icon:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }

    .form-group input {
      width: calc(100% - 28px); 
      padding: 14px; 
      border: 1px solid var(--input-border-light);
      border-radius: 10px; 
      font-size: 1em;
      font-family: var(--font-family);
      background-color: var(--input-bg-light);
      color: var(--text-color-light);
      transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
    }
    body.dark-mode .form-group input {
      background-color: var(--input-bg-dark);
      border-color: var(--input-border-dark);
      color: var(--text-color-dark);
    }
    .form-group input:focus {
      border-color: var(--input-focus-border-light);
      box-shadow: 0 0 0 3.5px color-mix(in srgb, var(--input-focus-border-light) 25%, transparent);
      outline: none;
    }
    body.dark-mode .form-group input:focus {
      border-color: var(--input-focus-border-dark);
      box-shadow: 0 0 0 3.5px color-mix(in srgb, var(--input-focus-border-dark) 25%, transparent);
    }

    .buttons-group {
      margin-top: 35px;
      margin-bottom: 35px;
      display: flex;
      justify-content: center;
      gap: 20px; 
    }
    button {
      padding: 13px 30px; 
      border: none;
      border-radius: 10px; 
      cursor: pointer;
      font-size: 1.05em; 
      font-weight: 600;
      font-family: var(--font-family);
      transition: transform 0.2s, background-color 0.3s, box-shadow 0.2s;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 10px; 
    }
    button svg {
        width: 20px; 
        height: 20px;
        fill: currentColor;
    }
    button:hover:not(:disabled) {
      transform: translateY(-3px); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    button:disabled {
      opacity: 0.5; 
      cursor: not-allowed;
    }

    #runBtn {
      background-color: var(--button-run-bg-light);
      color: var(--button-text-color);
    }
    body.dark-mode #runBtn { 
        background-color: var(--button-run-bg-dark);
        color: var(--button-text-color-dark);
    }
    #runBtn:hover:not(:disabled) { background-color: var(--button-run-hover-bg-light); }
    body.dark-mode #runBtn:hover:not(:disabled) { background-color: var(--button-run-hover-bg-dark); }

    #cancelBtn {
      background-color: var(--button-cancel-bg-light);
      color: var(--button-text-color);
      display: none;
    }
    body.dark-mode #cancelBtn { 
        background-color: var(--button-cancel-bg-dark);
        color: var(--button-text-color-dark);
    }
    #cancelBtn:hover:not(:disabled) { background-color: var(--button-cancel-hover-bg-light); }
    body.dark-mode #cancelBtn:hover:not(:disabled) { background-color: var(--button-cancel-hover-bg-dark); }

    #themeToggle {
      position: absolute;
      top: 20px; 
      right: 20px;
      cursor: pointer;
      font-size: 1.5em; 
      background: none;
      border: none;
      padding: 0; 
      width: 36px; 
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--theme-toggle-color-light);
      border-radius: 50%;
      transition: background-color 0.2s, color 0.3s, transform 0.2s;
      z-index: 10;
    }
     body.dark-mode #themeToggle {
      color: var(--theme-toggle-color-dark);
    }
    #themeToggle:hover {
      background-color: color-mix(in srgb, var(--theme-toggle-color-light) 10%, transparent);
      transform: scale(1.15); 
    }
     body.dark-mode #themeToggle:hover {
      background-color: color-mix(in srgb, var(--theme-toggle-color-dark) 10%, transparent);
    }
    
    #notificationsContainer {
      position: fixed;
      top: 80px; /* Adjusted for potential header/toggle */
      right: 20px;
      display: flex;
      flex-direction: column; 
      gap: 10px;
      z-index: 1000;
      max-width: 380px; 
    }
    .notification-item {
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 1em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateX(120%); /* Start off-screen from right */
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, background-color 0.3s, color 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notification-item.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification-item-message {
      flex-grow: 1;
      word-break: break-word;
    }
    .notification-item-close {
      background: none;
      border: none;
      color: inherit; 
      opacity: 0.7;
      font-size: 1.5em; /* Larger X */
      font-weight: bold;
      padding: 0 0 0 10px; 
      cursor: pointer;
      line-height: 1;
      margin-left: 5px;
    }
    .notification-item-close:hover {
      opacity: 1;
    }


    .status-card {
      background-color: var(--status-card-bg-light);
      border: 1px solid var(--status-card-border-light);
      border-radius: 16px; 
      padding: 30px; 
      margin-top: 30px;
      text-align: center; 
      min-height: 130px; 
      display: flex; /* Default to flex, content will dictate visibility */
      flex-direction: column;
      gap: 15px; 
      box-shadow: 0 6px 25px rgba(0,0,0,0.07);
      transition: background-color 0.4s, border-color 0.4s;
      position: relative; 
    }
    body.dark-mode .status-card {
      background-color: var(--status-card-bg-dark);
      border-color: var(--status-card-border-dark);
    }
    .status-card div {
      font-size: 1.05em; 
    }
    .status-card strong {
      font-weight: 600;
    }
    .status-header {
      display: flex;
      align-items: center;
      justify-content: center; 
      font-size: 1.3em !important; 
      font-weight: 700;
    }
    .status-header .icon {
      margin-right: 15px; 
      font-size: 1.5em; 
    }
    .status-info-item {
        font-size: 0.95em; 
        color: var(--label-color-light);
    }
    body.dark-mode .status-info-item {
        color: var(--label-color-dark);
    }
    .status-info-item strong {
        color: var(--text-color-light);
    }
    body.dark-mode .status-info-item strong {
        color: var(--text-color-dark);
    }

    .footer-note {
      margin-top: 25px; /* Reduced margin */
      font-size: 0.9em; 
      color: var(--footer-text-light);
      max-width: 600px;
      text-align: center;
    }
    body.dark-mode .footer-note {
      color: var(--footer-text-dark);
    }
    .copyright-footer {
      text-align: center;
      font-size: 0.85em;
      color: var(--footer-text-light);
      padding: 20px 0 15px 0; 
      width: 100%;
      z-index: 1; 
      margin-top: auto; /* Pushes footer to bottom */
    }
    body.dark-mode .copyright-footer {
      color: var(--footer-text-dark);
    }

    .sr-only { /* Screen reader only text */
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>

  <button id="themeToggle" aria-label="Toggle theme">🌙</button>
  <div id="notificationsContainer"></div>

  <div class="container">
    <h1><span class="app-icon">🚀</span>AutoGitFlow: GitHub Actions Accelerator</h1>

    <div class="form-group">
      <label for="owner">GitHub Owner/Organization:
        <span class="tooltip-icon">i<span class="tooltip-text">The username or organization that owns the repository (e.g., 'octocat').</span></span>
      </label>
      <input type="text" id="owner" placeholder="e.g., octocat">
    </div>
    <div class="form-group">
      <label for="repo">Repository Name:
        <span class="tooltip-icon">i<span class="tooltip-text">The name of the repository (e.g., 'Spoon-Knife').</span></span>
      </label>
      <input type="text" id="repo" placeholder="e.g., Spoon-Knife">
    </div>
    <div class="form-group">
      <label for="token">Personal Access Token (PAT):
        <span class="tooltip-icon">i<span class="tooltip-text">Your GitHub PAT with 'repo' and 'workflow' scopes. When copied, it's lightly obfuscated. Not stored by this page.</span></span>
      </label>
      <input type="password" id="token" placeholder="Enter your GitHub PAT">
    </div>

    <div class="buttons-group">
      <button id="runBtn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 13.5V8c0-2.071 1.679-3.75 3.75-3.75h1.25a.75.75 0 010 1.5H7.75A2.25 2.25 0 005.5 8v5.5H4zm1.5 2V20c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H7.25A3.25 3.25 0 014 20v-4.5h1.5zm11.254-8.87a.752.752 0 01-.137.954l-5.325 5.093a.75.75 0 01-.984 0l-2.675-2.558a.75.75 0 11.984-1.076l2.128 2.035 4.88-4.666a.75.75 0 011.091.121L17.47 7.5h1.78a.75.75 0 010 1.5h-1.026l1.03 1.096zM15.5 4.25c.966 0 1.75.784 1.75 1.75v1.25a.75.75 0 01-1.5 0V6a.25.25 0 00-.25-.25H14a.75.75 0 010-1.5h1.5z"></path><path d="M12.28 10.743a.75.75 0 10-.976 1.132l1.743 1.493.001.002-2.08 1.98a.75.75 0 10.984 1.076L14 14.39v4.86a.75.75 0 001.5 0V13.5c0-.69-.099-1.353-.28-1.98l-2.94-2.778z"></path></svg>
        Run Workflow
      </button>
      <button id="cancelBtn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm3.707-11.707a.999.999 0 00-1.414 0L12 10.586 9.707 8.293a.999.999 0 10-1.414 1.414L10.586 12l-2.293 2.293a.999.999 0 101.414 1.414L12 13.414l2.293 2.293a.997.997 0 001.414 0 .999.999 0 000-1.414L13.414 12l2.293-2.293a.999.999 0 000-1.414z"></path></svg>
        Cancel Workflow
      </button>
    </div>
    
    <div class="status-card" id="statusCard"> <!-- Removed style="display: none;" -->
      <div class="status-header">
        <span class="icon" id="statusIcon"></span>
        <span id="statusText"></span>
      </div>
      <div id="repoInfoDisplay" class="status-info-item"></div>
      <div id="timerDisplay" class="status-info-item"></div>
      <div id="startTimeDisplay" class="status-info-item"></div>
      <div id="artifactDownloadContainer"></div>

    </div>

  </div>
  <p class="footer-note">Your PAT is used directly for API calls. If copied, it undergoes simple obfuscation. Not stored after page close.</p>
  <p class="copyright-footer">copyright©okinr.testcase all rights reserved</p>

  <script>
    const ownerInput = document.getElementById('owner');
    const repoInput = document.getElementById('repo');
    const tokenInput = document.getElementById('token');
    const runBtn = document.getElementById('runBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const themeToggleBtn = document.getElementById('themeToggle');
    const notificationsContainerEl = document.getElementById('notificationsContainer');

    const statusCardEl = document.getElementById('statusCard');
    const statusIconEl = document.getElementById('statusIcon');
    const statusTextEl = document.getElementById('statusText');
    const timerDisplayEl = document.getElementById('timerDisplay');
    const startTimeDisplayEl = document.getElementById('startTimeDisplay');
    const repoInfoDisplayEl = document.getElementById('repoInfoDisplay');

    let currentRunId = null;
    let statusCheckInterval = null;
    let workflowTimerInterval = null;
    let workflowStartTime = null;
    let secondsElapsed = 0;
    const DEFAULT_WORKFLOW_FILE = 'main.yml';

    ownerInput.value = '';
    repoInput.value = '';
    tokenInput.value = '';

    function applyTheme(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        themeToggleBtn.innerHTML = isDark ? '☀️<span class="sr-only">Activate light mode</span>' : '🌙<span class="sr-only">Activate dark mode</span>';
        localStorage.setItem('autoGitFlowTheme', isDark ? 'dark' : 'light');
    }

    themeToggleBtn.addEventListener('click', () => {
        applyTheme(!document.body.classList.contains('dark-mode'));
    });
    
    const savedTheme = localStorage.getItem('autoGitFlowTheme');
    if (savedTheme) {
        applyTheme(savedTheme === 'dark');
    } else {
        applyTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    }
    
    tokenInput.addEventListener('copy', function(event) {
      const selection = document.getSelection().toString();
      if (selection && selection.length > 0) {
        try {
          const obfuscatedPAT = btoa(selection);
          event.clipboardData.setData('text/plain', `Copied (obfuscated): ${obfuscatedPAT}`);
          event.preventDefault();
          notify('PAT copied to clipboard (obfuscated). This is not strong encryption and only intended as a light deterrent.', 'warning', 7000);
        } catch (e) {
          console.error("Error obfuscating PAT on copy:", e);
        }
      }
    });

    function notify(message, type = 'info', autoDismissDelay = null) {
        const notificationItem = document.createElement('div');
        notificationItem.classList.add('notification-item');

        const messageSpan = document.createElement('span');
        messageSpan.classList.add('notification-item-message');
        messageSpan.textContent = message;
        notificationItem.appendChild(messageSpan);

        let bgColor, textColor;
        const isDark = document.body.classList.contains('dark-mode');
        switch (type) {
            case 'success':
            bgColor = isDark ? 'var(--notification-success-bg-dark)' : 'var(--notification-success-bg-light)';
            textColor = isDark ? 'var(--notification-success-text-dark)' : 'var(--notification-success-text-light)';
            break;
            case 'error':
            bgColor = isDark ? 'var(--notification-error-bg-dark)' : 'var(--notification-error-bg-light)';
            textColor = isDark ? 'var(--notification-error-text-dark)' : 'var(--notification-error-text-light)';
            break;
            case 'warning':
            bgColor = isDark ? 'var(--notification-warning-bg-dark)' : 'var(--notification-warning-bg-light)';
            textColor = isDark ? 'var(--notification-warning-text-dark)' : 'var(--notification-warning-text-light)';
            break;
            default: 
            bgColor = isDark ? 'var(--notification-info-bg-dark)' : 'var(--notification-info-bg-light)';
            textColor = isDark ? 'var(--notification-info-text-dark)' : 'var(--notification-info-text-light)';
        }
        notificationItem.style.backgroundColor = bgColor;
        notificationItem.style.color = textColor;

        const closeButton = document.createElement('button');
        closeButton.classList.add('notification-item-close');
        closeButton.innerHTML = '&times;';
        closeButton.setAttribute('aria-label', 'Close notification');
        closeButton.onclick = () => {
            notificationItem.style.opacity = '0';
            notificationItem.style.transform = 'translateX(120%)';
            setTimeout(() => notificationItem.remove(), 400); 
        };
        notificationItem.appendChild(closeButton);
        
        notificationsContainerEl.insertBefore(notificationItem, notificationsContainerEl.firstChild);
        
        requestAnimationFrame(() => {
            requestAnimationFrame(() => { 
                 notificationItem.classList.add('show');
            });
        });

        if (autoDismissDelay) {
            setTimeout(() => {
                if (notificationItem.parentElement) {
                    notificationItem.style.opacity = '0';
                    notificationItem.style.transform = 'translateX(120%)';
                    setTimeout(() => notificationItem.remove(), 400);
                }
            }, autoDismissDelay);
        }
    }
    
    function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return [hours, minutes, seconds]
            .map(val => val.toString().padStart(2, '0'))
            .join(':');
    }

    function updateStatusCard(icon, text, repoInfo = null, timerText = null, startTimeInfo = null) {
        statusCardEl.style.display = 'flex'; 
        statusIconEl.textContent = icon;
        statusTextEl.textContent = text;

        if (repoInfo !== null) repoInfoDisplayEl.innerHTML = `<strong>Repo:</strong> ${repoInfo}`;
        else repoInfoDisplayEl.innerHTML = ''; 
        
        if (timerText !== null) timerDisplayEl.innerHTML = `<strong>Duration:</strong> ${timerText}`;
        else timerDisplayEl.innerHTML = ''; 

        if (startTimeInfo !== null) startTimeDisplayEl.innerHTML = `<strong>Started:</strong> ${startTimeInfo}`;
        else startTimeDisplayEl.innerHTML = ''; 
    }
    
    function hideStatusCard() {
        statusCardEl.style.display = 'none';
    }

    function startWorkflowTimer() {
      stopWorkflowTimer(false); 
      workflowStartTime = new Date();
      secondsElapsed = 0;
      
      const formattedStartTime = workflowStartTime.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'medium' });
      const currentOwner = ownerInput.value.trim();
      const currentRepo = repoInput.value.trim();
      const repoInfo = `${currentOwner}/${currentRepo}`;

      updateStatusCard('⏳', 'Workflow Running...', repoInfo, formatTime(secondsElapsed), formattedStartTime);

      workflowTimerInterval = setInterval(() => {
        secondsElapsed++;
        updateStatusCard('⏳', 'Workflow Running...', repoInfo, formatTime(secondsElapsed), formattedStartTime);
      }, 1000);
    }

    function stopWorkflowTimer() {
      clearInterval(workflowTimerInterval);
      workflowTimerInterval = null;
    }
    
    function resetStatusDisplay() {
        stopWorkflowTimer(); 
        hideStatusCard(); 
        workflowStartTime = null;
        secondsElapsed = 0; 
    }

    async function githubApiRequest(endpoint, method = 'GET', body = null) {
      const owner = ownerInput.value.trim();
      const repo = repoInput.value.trim();
      const token = tokenInput.value.trim();

      if (!owner || !repo || !token) {
        notify('Owner, Repo, and Token must be provided!', 'error', 5000);
        throw new Error('Configuration missing');
      }

      const headers = {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'X-GitHub-Api-Version': '2022-11-28'
      };
      if (body) {
        headers['Content-Type'] = 'application/json';
      }

      const response = await fetch(`https://api.github.com${endpoint}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });

      if ((method === 'POST' && endpoint.includes('/dispatches') && response.status === 204) ||
          (method === 'POST' && endpoint.includes('/cancel') && response.status === 202)) { 
        return { status: response.status, ok: true, data: null }; 
      }

      const responseData = (response.status !== 204 && response.status !== 202) ? await response.json().catch(() => null) : null;

      if (!response.ok) {
        const errorMessage = responseData?.message || `HTTP error! status: ${response.status}`;
        console.error('GitHub API Error:', responseData || response.statusText);
        notify(`API Error: ${errorMessage}`, 'error', 7000);
        throw new Error(errorMessage);
      }
      
      return { status: response.status, ok: true, data: responseData};
    }

    function resetControls(isInitial = false, preserveStatusCard = false) {
        runBtn.disabled = false;
        cancelBtn.style.display = 'none';
        cancelBtn.disabled = true;
        currentRunId = null; 
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;

        if (isInitial) {
            updateStatusCard(
                '👋', 
                "Welcome! Provide GitHub details and click 'Run' to start.",
                null, null, null 
            );
        } else if (!preserveStatusCard) {
            resetStatusDisplay(); 
        }
    }


    async function checkRunStatus() {
      if (!currentRunId) return;
      const owner = ownerInput.value.trim();
      const currentRepoValue = repoInput.value.trim();
      const repoInfo = `${owner}/${currentRepoValue}`;
      const formattedStartTime = workflowStartTime ? workflowStartTime.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'medium' }) : 'N/A';

      try {
        const response = await githubApiRequest(`/repos/${owner}/${currentRepoValue}/actions/runs/${currentRunId}`);
        const runDetails = response.data;
        if (runDetails) {
          let statusIcon = '⏳';
          let statusMessage = `Status: ${runDetails.status} (${runDetails.conclusion || 'running'})`;

          if (runDetails.status === 'completed') {
            stopWorkflowTimer(); 
            clearInterval(statusCheckInterval); // Clears the current poll (long or short-term)
            statusCheckInterval = null;
            if (runDetails.conclusion === 'success') {
              statusIcon = '✅';
              statusMessage = 'Workflow completed successfully!';
              notify(statusMessage, 'success', 5000);

              // ⬇️ Tambahan untuk render button download artifact:
              await renderArtifactDownloadButton(currentRunId);

              // const container = document.getElementById('artifactDownloadContainer');
              // container.innerHTML = ''; // Clear sebelumnya

              // const artifactPageUrl = `https://github.com/${owner}/${currentRepoValue}/actions/runs/${currentRunId}`;
              // const githubButton = document.createElement('a');
              // githubButton.href = artifactPageUrl;
              // githubButton.target = '_blank';
              // githubButton.innerHTML = '🔗 <strong>Visit Artifact on GitHub</strong>';
              // githubButton.style.cssText = `
              //   display: inline-block;
              //   margin-top: 15px;
              //   padding: 10px 20px;
              //   background: linear-gradient(135deg, #4CAF50, #45a049);
              //   color: white;
              //   border-radius: 8px;
              //   text-decoration: none;
              //   font-weight: bold;
              //   box-shadow: 0 4px 8px rgba(0,0,0,0.2);
              //   transition: transform 0.2s, box-shadow 0.2s;
              // `;
              // githubButton.onmouseover = () => {
              //   githubButton.style.transform = 'scale(1.05)';
              //   githubButton.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
              // };
              // githubButton.onmouseout = () => {
              //   githubButton.style.transform = 'scale(1)';
              //   githubButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
              // };

              // container.appendChild(githubButton);



            } else if (runDetails.conclusion === 'cancelled') {
              statusIcon = '🛑';
              statusMessage = 'Workflow Cancelled.';
              notify(statusMessage, 'info', 5000); // Changed to 'info'
            }
            else {
              statusIcon = '❌';
              statusMessage = `Workflow ${runDetails.conclusion || 'failed'}!`;
              notify(statusMessage, 'error', 7000);
            }
            updateStatusCard(statusIcon, statusMessage, repoInfo, formatTime(secondsElapsed), formattedStartTime);
            resetControls(false, true); 
          } else if (runDetails.status === 'in_progress' || runDetails.status === 'queued' || runDetails.status === 'requested') {
             statusIcon = '⏳'; 
             statusMessage = `Workflow ${runDetails.status}...`;
             updateStatusCard(statusIcon, statusMessage, repoInfo, formatTime(secondsElapsed), formattedStartTime);
          } else { 
             statusIcon = '🛑'; 
             statusMessage = `Workflow ${runDetails.status} (${runDetails.conclusion || 'unknown'})`;
             stopWorkflowTimer();
             clearInterval(statusCheckInterval);
             statusCheckInterval = null;
             updateStatusCard(statusIcon, statusMessage, repoInfo, formatTime(secondsElapsed), formattedStartTime);
             resetControls(false, true); 
          }
        }
      } catch (error) {
        console.error('Error checking status:', error);
        // Do not reset controls here if it's a transient error during polling,
        // unless it's a specific error indicating the run is gone (e.g., 404 on run ID)
        // For now, let the poll continue unless it's cleared by finding a terminal state
        // or by the max attempts logic in cancel confirmation.
      }
    }
    async function renderArtifactDownloadButton(runId) {
        const owner = ownerInput.value.trim();
        const repo = repoInput.value.trim();
        const token = tokenInput.value.trim();
        const container = document.getElementById('artifactDownloadContainer');

        // Kosongkan container dulu
        container.innerHTML = '';

        try {
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/artifacts`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            const data = await res.json();
            if (data.total_count === 0) {
                container.innerHTML = '<p>No artifacts available for download.</p>';
                return;
            }

            data.artifacts.forEach(artifact => {
                const btn = document.createElement('button');
                btn.textContent = `⬇️ Download: ${artifact.name}`;
                btn.style.margin = '8px';
                btn.onclick = async () => {
                    // const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${artifact.id}/zip`, {
                    //     method: 'GET',
                    //     headers: {
                    //         'Authorization': `Bearer ${token}`,
                    //         'Accept': 'application/vnd.github.v3+json'
                    //     },
                    //     redirect: 'manual' // So we can capture 302 Location
                    // });

                    // console.log('Ini isinya apa artifact id ', artifact.id)
                    // console.log('Ini isinya apa sih ', res)
                    // console.log('Dapat statuys apa pas klik button ', res.status)

                    // if (res.status === 302) {
                    //     const downloadUrl = res.headers.get('Location');
                    //     console.log('download URL: ', downloadUrl)
                    //     window.open(downloadUrl, '_blank');
                    // } else {
                    //     notify('❌ Unable to fetch artifact download link.', 'error', 5000);
                    // }
                    const myRequest = new Request(`https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${artifact.id}/zip`, {
                      method: 'GET',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      redirect: 'manual' // kita mau lihat apakah redirect
                    });

                    fetch(myRequest)
                      .then(response => {
                        console.log('=== Response Object ===');
                        console.log(response);
                        console.log('URL:', response.url);
                        console.log('Status:', response.status);
                        console.log('Status Text:', response.statusText);
                        console.log('Type:', response.type); // basic, cors, opaque, opaqueredirect
                        console.log('Redirected:', response.redirected);
                        console.log('OK:', response.ok);
                        console.log('Headers:', response.headers);

                        for (const [key, value] of response.headers.entries()) {
                          console.log(`Header: ${key} = ${value}`);
                        }

                        if (response.status === 302) {
                          const location = response.headers.get('Location');
                          console.log('Redirect Location:', location);
                        } else if (response.ok) {
                          return response.blob();
                        } else {
                          throw new Error('Unexpected response status: ' + response.status);
                        }
                      })
                      .then(blob => {
                        if (blob) {
                          console.log('=== Blob Object ===');
                          console.log(blob);
                          const objectURL = URL.createObjectURL(blob);
                          console.log('Generated Object URL:', objectURL);

                          // OPTIONAL: Tampilkan blob sebagai link download
                          const link = document.createElement('a');
                          link.href = objectURL;
                          link.download = 'artifact.zip';
                          link.textContent = '⬇️ Download Artifact';
                          document.body.appendChild(link);
                        }
                      })
                      .catch(error => {
                        console.error('❌ Error:', error);
                      });
                };
                container.appendChild(btn);
            });

        } catch (err) {
            console.error('Error fetching artifacts:', err);
            container.innerHTML = '<p>Error fetching artifacts.</p>';
        }
    }


    runBtn.addEventListener('click', async () => {
      const owner = ownerInput.value.trim();
      const repo = repoInput.value.trim();
      const token = tokenInput.value.trim();

      if (!owner || !repo || !token) {
        notify('Please fill all fields: Owner, Repo, and Token.', 'error', 5000);
        return;
      }

      resetControls(false, false); 
      runBtn.disabled = true;
      cancelBtn.style.display = 'inline-flex'; 
      cancelBtn.disabled = true; 
      
      const repoInfo = `${owner}/${repo}`;
      updateStatusCard('⏳', 'Dispatching workflow... Finding Run ID...', repoInfo, null, null);
      
      const dispatchTime = new Date(); 

      try {
        await githubApiRequest(`/repos/${owner}/${repo}/actions/workflows/${DEFAULT_WORKFLOW_FILE}/dispatches`, 'POST', { ref: 'main' });
        notify('Workflow dispatched! Attempting to find Run ID...', 'info', 5000);
        
        setTimeout(async () => {
          try {
            const response = await githubApiRequest(`/repos/${owner}/${repo}/actions/runs`);
            const runData = response.data;
            if (runData && runData.workflow_runs) {
              const newRun = runData.workflow_runs
                .filter(run => new Date(run.created_at) >= dispatchTime)
                .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))[0];

              if (newRun) {
                currentRunId = newRun.id;
                startWorkflowTimer(); 
                cancelBtn.disabled = false; 
                notify(`Monitoring Run ID: ${currentRunId}. Status: ${newRun.status}`, 'info', 7000);
                
                if (statusCheckInterval) clearInterval(statusCheckInterval);
                statusCheckInterval = setInterval(checkRunStatus, 5000); 
                await checkRunStatus(); 
              } else {
                notify('Could not identify the new workflow run. Please check GitHub Actions manually.', 'error', 7000);
                updateStatusCard('❓', 'Could not find Run ID.', repoInfo, null, null);
                resetControls(false, true); 
              }
            } else {
               notify('Failed to fetch workflow runs to identify Run ID.', 'error', 7000);
               updateStatusCard('❓', 'Failed to fetch runs.', repoInfo, null, null);
               resetControls(false, true); 
            }
          } catch (fetchRunError) {
            console.error('Error fetching run ID:', fetchRunError);
            notify(`Error finding Run ID: ${fetchRunError.message}`, 'error', 7000);
            updateStatusCard('⚠️', `Error finding Run ID.`, repoInfo, null, null);
            resetControls(false, true); 
          }
        }, 7000); 

      } catch (dispatchError) {
        console.error('Dispatch error:', dispatchError);
        updateStatusCard('❌', 'Failed to dispatch workflow.', repoInfo, null, null);
        resetControls(false, true); 
      }
    });

    cancelBtn.addEventListener('click', async () => {
      if (!currentRunId) {
        notify('No active run to cancel.', 'warning', 5000);
        return;
      }
      const owner = ownerInput.value.trim();
      const currentRepoValue = repoInput.value.trim();
      const repoInfo = `${owner}/${currentRepoValue}`;
      const formattedStartTime = workflowStartTime ? workflowStartTime.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'medium' }) : 'N/A';

      cancelBtn.disabled = true;
      updateStatusCard('⏳', 'Attempting to cancel workflow...', repoInfo, formatTime(secondsElapsed), formattedStartTime);

      try {
        const cancelResponse = await githubApiRequest(`/repos/${owner}/${currentRepoValue}/actions/runs/${currentRunId}/cancel`, 'POST');
        
        if (cancelResponse.ok && cancelResponse.status === 202) {
            notify('Workflow cancellation requested. Verifying final status...', 'info', 5000);
            stopWorkflowTimer(); // Preserve secondsElapsed
            
            clearInterval(statusCheckInterval); // Clear any existing long poll
            statusCheckInterval = null;

            updateStatusCard('⏳', 'Verifying cancellation...', repoInfo, formatTime(secondsElapsed), formattedStartTime);

            let cancelConfirmAttempts = 0;
            const MAX_CANCEL_CONFIRM_ATTEMPTS = 20; 
            const CANCEL_CONFIRM_INTERVAL_MS = 5000;

            const attemptCancelConfirmation = async () => {
                cancelConfirmAttempts++;
                await checkRunStatus(); // This will update UI and clear interval if terminal
                
                // If statusCheckInterval is still active, it means checkRunStatus didn't find a terminal state yet
                if (statusCheckInterval && cancelConfirmAttempts >= MAX_CANCEL_CONFIRM_ATTEMPTS) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                    notify('Could not confirm cancellation status after several attempts. Please check GitHub.', 'error', 10000);
                    updateStatusCard('❓', 'Cancellation status unclear. Check GitHub.', repoInfo, formatTime(secondsElapsed), formattedStartTime);
                    resetControls(false, true); // Reset controls, keeping the card
                }
            };

            statusCheckInterval = setInterval(attemptCancelConfirmation, CANCEL_CONFIRM_INTERVAL_MS);
            await attemptCancelConfirmation(); // Initial immediate check

        } else {
            // This case might be reached if githubApiRequest returns ok:true but status isn't 202 for cancel (unlikely for this specific API)
            notify(`Unexpected response from cancel request (HTTP ${cancelResponse.status}). Please verify on GitHub.`, 'error', 7000);
            cancelBtn.disabled = false;
            updateStatusCard('❌', `Cancellation request unexpected (HTTP ${cancelResponse.status}).`, repoInfo, formatTime(secondsElapsed), formattedStartTime);
        }
      } catch (cancelError) {
        console.error('Cancel error:', cancelError);
        notify(`Cancellation API error: ${cancelError.message}`, 'error', 7000);
        cancelBtn.disabled = false; // Re-enable on API call failure
        updateStatusCard('❌', 'Failed to send cancel request.', repoInfo, formatTime(secondsElapsed), formattedStartTime);
      }
    });
    
    resetControls(true); 

  </script>
</body>
</html>
